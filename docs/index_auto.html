<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>日本の郵便番号API | autoComplete.js連携</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- autoComplete.js CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.min.css" />

  <style>
    #grid { display:grid; grid-template-rows:auto 1fr auto; min-height:100vh; }
    .ac-container { max-width: 640px; }
  </style>
</head>
<body>
<div id="grid">
  <nav class="navbar bg-primary-subtle">
    <div class="container"><span class="navbar-brand">日本の郵便番号API</span></div>
  </nav>

  <main class="container mt-4">
    <!-- 郵便番号入力 -->
    <form id="form" class="row row-cols-lg-auto g-3 align-items-end">
      <div class="col-12">
        <label class="form-label" for="postal-code">郵便番号</label>
        <div class="input-group">
          <span class="input-group-text">〒</span>
          <input id="postal-code" class="form-control" type="search"
                 placeholder="例：1000014 or 100-0014"
                 inputmode="numeric" pattern="(\d{7}|\d{3}-\d{4})" required />
        </div>
        <div class="form-text">7桁で自動検索（送信ボタンでも可）</div>
      </div>
      <div class="col-12">
        <button class="btn btn-primary" id="fetch-btn" type="submit">
          住所を取得
          <span id="spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>
      <div class="col-12">
        <div id="msg" class="text-secondary" aria-live="polite"></div>
      </div>
    </form>

    <!-- 候補検索（autoComplete.js） -->
    <section id="ac-section" class="mt-4 d-none">
      <label class="form-label" for="addr-ac">候補を検索（町域・事業所名などで絞り込み）</label>
      <div class="ac-container">
        <input id="addr-ac" class="form-control" type="search" placeholder="例：永田町、霞が関、〇〇株式会社 など" />
      </div>
      <div class="form-text">候補が複数ある場合のみ表示されます。</div>
    </section>

    <!-- 住所フォーム -->
    <section class="mt-4">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <label for="pref" class="form-label">都道府県</label>
          <input id="pref" class="form-control" autocomplete="address-level1">
        </div>
        <div class="col-12 col-md-4">
          <label for="city" class="form-label">市区町村</label>
          <input id="city" class="form-control" autocomplete="address-level2">
        </div>
        <div class="col-12 col-md-5">
          <label for="line1" class="form-label">町域・丁目</label>
          <input id="line1" class="form-control" autocomplete="address-line1" placeholder="例：永田町1-1 など">
        </div>
        <div class="col-12">
          <label for="line2" class="form-label">建物名・部屋番号（任意）</label>
          <input id="line2" class="form-control" autocomplete="address-line2" placeholder="例：〇〇ビル 101号室">
        </div>
      </div>
    </section>

    <!-- デバッグ（任意） -->
    <details class="mt-4">
      <summary class="mb-2">レスポンス確認（デバッグ用）</summary>
      <div id="result" class="d-none">
        <div class="card mb-2"><div class="card-body">
          エンドポイント：<a id="endpoint" target="_blank" rel="noopener"></a>
        </div></div>
        <div class="card"><div class="card-body"><pre id="response" class="mb-0"></pre></div></div>
      </div>
    </details>
  </main>
</div>

<!-- JS（Bootstrap） -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- autoComplete.js -->
<script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script>

<script>
  // ====== 設定 ======
  const BASE = 'https://nishiokya.github.io/jp-postal-code-api/api/v1/';

  // ====== DOM ======
  const $form = document.getElementById('form');
  const $zip = document.getElementById('postal-code');
  const $msg = document.getElementById('msg');
  const $btn = document.getElementById('fetch-btn');
  const $spinner = document.getElementById('spinner');
  const $acSection = document.getElementById('ac-section');
  const $endpoint = document.getElementById('endpoint');
  const $response = document.getElementById('response');
  const $result = document.getElementById('result');

  const $pref = document.getElementById('pref');
  const $city = document.getElementById('city');
  const $line1 = document.getElementById('line1');
  const $line2 = document.getElementById('line2');

  // 取得済み候補を保持（autoComplete のデータソースに使う）
  let addressCache = [];  // [{label, rec}]
  let latestRequestId = 0;

  // ====== ユーティリティ ======
  const normZip = v => (v || '').replace(/[^\d]/g, '');
  const setLoading = b => { $btn.disabled = b; $spinner.classList.toggle('d-none', !b); };
  const showMsg = (t, type='secondary') => { $msg.className = `text-${type}`; $msg.textContent = t || ''; };
  const clearAddress = () => { $pref.value=''; $city.value=''; $line1.value=''; /* line2は残す */ };
  const joinJa = ja => `${ja.prefecture}${ja.address1}${ja.address2}${ja.address3}${ja.address4}`.replace(/\s+/g,'');

  function fillFromRecord(rec) {
    const ja = rec?.ja || {};
    $pref.value = ja.prefecture || '';
    $city.value = ja.address1 || '';
    const town = [ja.address2, ja.address3].filter(Boolean).join('');
    $line1.value = town || '';
    if (ja.address4 && !$line2.value) $line2.placeholder = ja.address4;
  }

  // ====== 郵便番号 → 候補取得 ======
  async function fetchByZip(zip) {
    const z = normZip(zip);
    if (z.length !== 7) {
      showMsg('7桁の郵便番号を入力してください。', 'muted');
      return;
    }
    setLoading(true);
    showMsg('検索中…', 'secondary');
    clearAddress();
    const reqId = ++latestRequestId;
    const url = `${BASE}${z}.json`;

    try {
      const res = await fetch(url, { cache: 'no-store' });
      // デバッグ表示
      if ($endpoint) { $endpoint.href = url; $endpoint.textContent = url; $result.classList.remove('d-none'); }
      if ($response) $response.textContent = '';

      if (reqId !== latestRequestId) return;

      if (!res.ok) {
        if ($response) $response.textContent = res.status === 404 ? '該当する住所が見つかりませんでした。' : 'エラーが発生しました。';
        showMsg(res.status === 404 ? '該当する住所が見つかりませんでした。' : 'エラーが発生しました。', res.status === 404 ? 'warning' : 'danger');
        addressCache = [];
        $acSection.classList.add('d-none');
        return;
      }

      const data = await res.json();
      if ($response) $response.textContent = JSON.stringify(data, null, 2);
      const list = data?.addresses || [];
      if (!list.length) {
        showMsg('該当する住所が見つかりませんでした。', 'warning');
        addressCache = [];
        $acSection.classList.add('d-none');
        return;
      }

      // 候補をキャッシュ（autoComplete用）
      addressCache = list.map(rec => ({ label: joinJa(rec.ja), rec }));

      if (addressCache.length === 1) {
        // 1件なら即反映
        fillFromRecord(addressCache[0].rec);
        $acSection.classList.add('d-none');
        showMsg('住所を自動補完しました。', 'success');
      } else {
        // 複数なら検索ボックスを表示
        $acSection.classList.remove('d-none');
        showMsg(`候補が ${addressCache.length} 件見つかりました。検索して選択してください。`, 'secondary');
      }
    } catch (e) {
      showMsg('ネットワークエラーが発生しました。', 'danger');
      addressCache = [];
      $acSection.classList.add('d-none');
    } finally {
      setLoading(false);
    }
  }

  // ====== autoComplete.js 初期化 ======
  const ac = new autoComplete({
    selector: "#addr-ac",
    placeHolder: "候補を検索",
    data: {
      src: async (query) => {
        // 直近の addressCache からフロント側で絞り込み
        const q = (query || '').trim();
        if (!q) return addressCache;
        const norm = s => s.normalize('NFKC');
        return addressCache.filter(item => norm(item.label).includes(norm(q)));
      },
      keys: ["label"],
      cache: false
    },
    threshold: 0,               // 0文字から結果を出す
    searchEngine: "loose",      // 緩めのマッチ
    resultsList: { maxResults: 30, tabSelect: true },
    resultItem: { highlight: true }
  });

  // 選択時の反映
  document.querySelector("#addr-ac").addEventListener("selection", (event) => {
    const item = event.detail.selection.value; // {label, rec}
    fillFromRecord(item.rec);
    event.target.value = item.label; // 入力欄へ表示
    showMsg('候補を反映しました。', 'success');
  });

  // 7桁到達で自動検索
  let timer;
  $zip.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(() => {
      const z = normZip($zip.value);
      if (z.length === 7) fetchByZip(z);
    }, 250);
  });

  // 送信でも検索
  $form.addEventListener('submit', (e) => {
    e.preventDefault();
    fetchByZip($zip.value);
  });
</script>
</body>
</html>