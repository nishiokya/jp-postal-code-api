<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>日本の郵便番号API | 3桁分割＋autoComplete.js</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- autoComplete.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script>

  <style>
    #grid { display:grid; grid-template-rows:auto 1fr auto; min-height:100vh; }
    .ac-group { max-width: 420px; }
    input[type="text"].zip { ime-mode: disabled; }
  </style>
</head>
<body>
<div id="grid">
  <nav class="navbar bg-primary-subtle">
    <div class="container"><span class="navbar-brand">日本の郵便番号API</span></div>
  </nav>

  <main class="container mt-4">
    <!-- 郵便番号 3桁 + 4桁 -->
    <form id="form" class="row g-3 align-items-end" autocomplete="on">
      <div class="col-12">
        <label class="form-label" for="zip3">郵便番号</label>
        <div class="input-group ac-group">
          <span class="input-group-text">〒</span>
          <input id="zip3" class="form-control zip" type="text" inputmode="numeric" pattern="\d{3}" maxlength="3"
                 placeholder="3桁（例：100）" autocomplete="postal-code" aria-label="郵便番号3桁" required>
          <span class="input-group-text">-</span>
          <input id="zip4" class="form-control zip" type="text" inputmode="numeric" pattern="\d{4}" maxlength="4"
                 placeholder="4桁（例：0014）" aria-label="郵便番号4桁" required>
          <button class="btn btn-primary" id="fetch-btn" type="submit">
            住所を取得
            <span id="spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
        <div class="form-text">3桁を選ぶ/入力 → 4桁入力で自動検索（送信でも可）</div>
        <div id="msg" class="text-secondary mt-1" aria-live="polite"></div>
      </div>
    </form>

    <!-- 住所フォーム -->
    <section class="mt-3">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <label for="pref" class="form-label">都道府県</label>
          <input id="pref" class="form-control" autocomplete="address-level1">
        </div>
        <div class="col-12 col-md-4">
          <label for="city" class="form-label">市区町村</label>
          <input id="city" class="form-control" autocomplete="address-level2">
        </div>
        <div class="col-12 col-md-5">
          <label for="line1" class="form-label">町域・丁目</label>
          <input id="line1" class="form-control" autocomplete="address-line1" placeholder="例：永田町1-1 など">
        </div>
        <div class="col-12">
          <label for="line2" class="form-label">建物名・部屋番号（任意）</label>
          <input id="line2" class="form-control" autocomplete="address-line2" placeholder="例：〇〇ビル 101号室">
        </div>
      </div>
    </section>

    <!-- 候補検索（郵便番号→住所が複数のとき表示） -->
    <section id="ac-section" class="mt-4 d-none">
      <label class="form-label" for="addr-ac">候補を検索（町域・事業所名などで絞り込み）</label>
      <input id="addr-ac" class="form-control" type="search" placeholder="例：永田町、霞が関、〇〇株式会社 など" />
      <div class="form-text">候補が複数ある場合のみ表示されます。</div>
    </section>

    <!-- デバッグ（任意） -->
    <details class="mt-4">
      <summary class="mb-2">レスポンス確認（デバッグ用）</summary>
      <div id="result" class="d-none">
        <div class="card mb-2"><div class="card-body">
          エンドポイント：<a id="endpoint" target="_blank" rel="noopener"></a>
        </div></div>
        <div class="card"><div class="card-body"><pre id="response" class="mb-0"></pre></div></div>
      </div>
    </details>
  </main>
</div>

<!-- JS（Bootstrap） -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ===== 設定 =====
  const BASE = 'https://nishiokya.github.io/jp-postal-code-api/api/v1/';      // APIのベース
  const SUGGEST_URL = 'https://nishiokya.github.io/jp-postal-code-api/api/v1/suggest/zip3.txt';     // 3桁候補ファイル

  // ===== DOM =====
  const $form = document.getElementById('form');
  const $zip3 = document.getElementById('zip3');
  const $zip4 = document.getElementById('zip4');
  const $btn = document.getElementById('fetch-btn');
  const $spinner = document.getElementById('spinner');
  const $msg = document.getElementById('msg');

  const $pref = document.getElementById('pref');
  const $city = document.getElementById('city');
  const $line1 = document.getElementById('line1');
  const $line2 = document.getElementById('line2');

  const $acSection = document.getElementById('ac-section');
  const $addrAc = document.getElementById('addr-ac');

  const $endpoint = document.getElementById('endpoint');
  const $response = document.getElementById('response');
  const $result = document.getElementById('result');

  // 状態
  let latestRequestId = 0;
  let addressCache = []; // [{label, rec}]

  // ===== Utils =====
  const onlyDigits = s => (s || '').replace(/\D/g, '');
  const setLoading = b => { $btn.disabled = b; $spinner.classList.toggle('d-none', !b); };
  const showMsg = (t, type='secondary') => { $msg.className = `text-${type}`; $msg.textContent = t || ''; };
  const clearAddress = () => { $pref.value=''; $city.value=''; $line1.value=''; /* line2は残す */ };
  const joinJa = ja => `${ja.prefecture}${ja.address1}${ja.address2}${ja.address3}${ja.address4}`.replace(/\s+/g,'');

  function fillFromRecord(rec) {
    const ja = rec?.ja || {};
    $pref.value = ja.prefecture || '';
    $city.value = ja.address1 || '';
    const town = [ja.address2, ja.address3].filter(Boolean).join('');
    $line1.value = town || '';
    if (ja.address4 && !$line2.value) $line2.placeholder = ja.address4;
  }

  function fullZip() {
    const a = onlyDigits($zip3.value).padEnd(3,'').slice(0,3);
    const b = onlyDigits($zip4.value).padEnd(4,'').slice(0,4);
    return (a.length===3 && b.length===4) ? a + b : '';
  }

  // ===== 3桁候補（autoComplete.js） =====
  let zip3List = [];
  async function loadZip3Suggestions() {
    try {
      const res = await fetch(SUGGEST_URL, { cache: 'no-store' });
      const text = await res.text();
      zip3List = text.split(/\r?\n/).map(s => s.trim()).filter(s => /^\d{3}$/.test(s));
      // autoComplete 初期化
      new autoComplete({
        selector: "#zip3",
        placeHolder: "3桁（例：100）",
        data: { src: zip3List, cache: true },
        threshold: 0,
        searchEngine: "strict",
        resultsList: { maxResults: 20, tabSelect: true },
        resultItem: { highlight: true }
      });
      document.querySelector("#zip3").addEventListener("selection", (ev) => {
        const v = ev.detail.selection.value;
        $zip3.value = v;
        $zip4.focus();
        maybeFetch();
      });
    } catch (e) {
      console.warn('zip3 suggest load failed', e);
    }
  }

  // ===== 郵便番号→候補取得 =====
  async function fetchByZip(zip) {
    setLoading(true);
    showMsg('検索中…', 'secondary');
    clearAddress();
    addressCache = [];
    const reqId = ++latestRequestId;
    const url = `${BASE}${zip}.json`;

    try {
      const res = await fetch(url, { cache: 'no-store' });
      if ($endpoint) { $endpoint.href = url; $endpoint.textContent = url; $result.classList.remove('d-none'); }
      if ($response) $response.textContent = '';

      if (reqId !== latestRequestId) return;

      if (!res.ok) {
        const notFound = res.status === 404;
        if ($response) $response.textContent = notFound ? '該当する住所が見つかりませんでした。' : 'エラーが発生しました。';
        showMsg(notFound ? '該当する住所が見つかりませんでした。' : 'エラーが発生しました。', notFound ? 'warning' : 'danger');
        $acSection.classList.add('d-none');
        return;
      }

      const data = await res.json();
      if ($response) $response.textContent = JSON.stringify(data, null, 2);
      const list = data?.addresses || [];
      if (!list.length) {
        showMsg('該当する住所が見つかりませんでした。', 'warning');
        $acSection.classList.add('d-none');
        return;
      }

      addressCache = list.map(rec => ({ label: joinJa(rec.ja), rec }));

      if (addressCache.length === 1) {
        fillFromRecord(addressCache[0].rec);
        $acSection.classList.add('d-none');
        showMsg('住所を自動補完しました。', 'success');
      } else {
        // 住所候補用 autoComplete をその場で準備（初期化は1回でOK）
        if (!$addrAc.dataset.inited) {
          const ac = new autoComplete({
            selector: "#addr-ac",
            placeHolder: "候補を検索",
            data: {
              src: async (q) => {
                const norm = (s) => (s || '').normalize('NFKC');
                const qq = norm(q || '');
                return qq ? addressCache.filter(x => norm(x.label).includes(qq)) : addressCache;
              },
              keys: ["label"],
              cache: false
            },
            threshold: 0,
            searchEngine: "loose",
            resultsList: { maxResults: 30, tabSelect: true },
            resultItem: { highlight: true }
          });
          document.querySelector("#addr-ac").addEventListener("selection", (event) => {
            const item = event.detail.selection.value;
            fillFromRecord(item.rec);
            event.target.value = item.label;
            showMsg('候補を反映しました。', 'success');
          });
          $addrAc.dataset.inited = '1';
        }
        $acSection.classList.remove('d-none');
        showMsg(`候補が ${addressCache.length} 件見つかりました。検索して選択してください。`, 'secondary');
      }
    } catch (e) {
      showMsg('ネットワークエラーが発生しました。', 'danger');
      $acSection.classList.add('d-none');
    } finally {
      setLoading(false);
    }
  }

  // 両方そろったら実行
  function maybeFetch() {
    const zip = fullZip();
    if (zip) fetchByZip(zip);
  }

  // ===== 入力ハンドラ =====
  // 数字以外を除去・桁そろいでフォーカス遷移
  function sanitizeZipInput(el, max) {
    const before = el.value;
    el.value = onlyDigits(before).slice(0, max);
  }
  $zip3.addEventListener('input', () => {
    sanitizeZipInput($zip3, 3);
    if ($zip3.value.length === 3) $zip4.focus();
  });
  $zip4.addEventListener('input', () => {
    sanitizeZipInput($zip4, 4);
    if ($zip4.value.length === 4) maybeFetch();
  });

  // フル郵便番号のペースト対応（どちらに貼ってもOK）
  function pasteHandler(ev) {
    const data = (ev.clipboardData || window.clipboardData).getData('text');
    const d = onlyDigits(data);
    if (/^\d{7}$/.test(d)) {
      ev.preventDefault();
      $zip3.value = d.slice(0,3);
      $zip4.value = d.slice(3);
      maybeFetch();
    }
  }
  $zip3.addEventListener('paste', pasteHandler);
  $zip4.addEventListener('paste', pasteHandler);

  // 送信ボタンでも検索
  $form.addEventListener('submit', (e) => {
    e.preventDefault();
    maybeFetch();
  });

  // 初期ロード：3桁候補を取得
  loadZip3Suggestions();
</script>
</body>
</html>